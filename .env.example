importMoralisfrom"moralis";=
import{EvmChain,EvmNftTransfer,EvmAddress}from'@moralisweb3/evm-utils';=
import{PrismaClient}from'@prisma/client'=
import{ImmutableX,Config,IMXError}from'@imtbl/core-sdk';=
import{getSigner}from'./utils';=
import*asdotenvfrom'dotenv';=
import*asfsfrom'fs';=
dotenv.config();=
asyncfunctiongetBurnTransfersByBlockRange(burnTransfers:EvmNftTransfer[]=
//CreatetheMoralisclient=
awaitMoralis.start({=
apiKey:process.env.MORALIS_API_KEY,=
});=
consttodayDate=
constcurrentblockresponse=
date:todayDate.toString(),=
chain:EvmChain.BSC,=
});=
constcurrentblock=
//Checktomakesuretheuserhasputablocknumberthat'snothigherthanthecurrentblock=
if(to_block>currentblock){=
console.log("Tryingtogetablockhigherthanthecurrentblock,settingtocurrentblock");=
to_block=
}=
//Checktomakesurethefrom_blockislessthantheto_block=
if(from_block>to_block){=
console.log("Tryingtogetafrom_blockhigherthantheto_block,settingfrom_blockto1");=
from_block=
}=
//Moralisdoesn'tallowrequestsformorethan1mblocksatatime=
if(to_block-from_block>1000000){=
console.log("MoralisAPIdoesn'tallowmorethan1millionblocksinarequest,settingto_blockto"+from_block+1000000);=
to_block=
}=
//Getalltransfersforacollectionaddressandchain=
try{=
constresponse=
address:process.env.ORIGIN_COLLECTION_ADDRESS!,=
chain:EvmChain.BSC,=
from_block:from_block,=
to_block:to_block,=
cursor:cursor=
});=
//console.log(response.result);=
//Optionaltimeoutifyougetratelimited=
//awaitnewPromise(f=
//Iteratethroughandsortouttheburntransfersandpushthemintoanarray,makesurenoduplicatetokenIDsareloaded=
constburnAddress=
for(constelementofresponse.result){=
if(element.toAddress.lowercase=
burnTransfers.push(element);=
usedtokenids.push(element.tokenId);=
}=
}=
//Checkifthere'sadditionalpagesandcursorthroughthem=
//Ifindexisincluded,it'sbecauseyouwanttolimittherequestswhiletesting=
//if(response.pagination&&index<5){=
if(response.pagination.cursor!=
console.log("Cursingthroughpage"+(index+1)+"oftransfersinblockrange"+from_block+"-"+to_block+"...");=
console.log(response.pagination);=
index++;=
returnawaitgetBurnTransfersByBlockRange(burnTransfers,from_block,to_block,response.pagination.cursor,index,usedtokenids);=
}=
console.log("Found"+burnTransfers.length+"burntransfersinblockrange")=
returnburnTransfers;=
}=
catch(err){=
console.log(err);=
console.log("Erroredout,retryingin1second...");=
awaitnewPromise(f=
returnawaitgetBurnTransfersByBlockRange(burnTransfers,from_block,to_block,cursor,index,usedtokenids);=
}=
}=
asyncfunctionbackFillBurnTransfers(prisma:PrismaClient,from_block:number,to_block:number,blockinterval:number){=
if((to_block-from_block)<blockinterval){=
console.log("Blockintervalislargerthantheblockrange,settingblockintervaltoblockrange");=
blockinterval=
}=
constbackfills:number=
console.log("Batchesofblockstobackfill:"+backfills);=
letindexblock=
while(indexblock<to_block){=
//Ifyou'reattheend,makesureyoudon'tgopastto_block=
if(indexblock+blockinterval>to_block){=
blockinterval=
}=
console.log("Gettingblocksinblockrange:"+indexblock+"-"+(indexblock+blockinterval));=
constburnTransfers=
if(burnTransfers.length>0){=
awaitloadBurnTransfers(prisma,burnTransfers);=
}=
indexblock+=
}=
console.log('Donebackfillingburntransfersinblockrange'+from_block+'-'+to_block);=
}=
asyncfunctionmonitorBurnTransfers(prisma:PrismaClient,last_polled_block:number,block_polling_interval:number){=
//CreatetheMoralisclient=
awaitMoralis.start({=
apiKey:process.env.MORALIS_API_KEY,=
});=
try{=
consttodayDate=
constcurrentblockresponse=
date:todayDate.toString(),=
chain:EvmChain.BSC,=
});=
constcurrentblock=
if(currentblock-last_polled_block>=
console.log("Currentblock"+currentblock+"exceedsthelastpolledblock"+last_polled_block+"bytheblockpollinginterval"+block_polling_interval+",backfilling...");=
awaitbackFillBurnTransfers(prisma,last_polled_block,currentblock,block_polling_interval);=
monitorBurnTransfers(prisma,currentblock,block_polling_interval);=
}=
else{=
console.log("Currentblock"+currentblock+"doesnotexceedthelastpolledblock"+last_polled_block+"bytheblockpollinginterval"+block_polling_interval);=
//Delaybeforecheckingagain=
awaitnewPromise(f=
monitorBurnTransfers(prisma,last_polled_block,block_polling_interval);=
}=
}=
catch(err){=
console.log(err);=
console.log("Erroredout,retryingin1second...");=
awaitnewPromise(f=
monitorBurnTransfers(prisma,last_polled_block,block_polling_interval);=
}=
}=
asyncfunctionloadBurnTransfers(prisma:PrismaClient,burnTransfers:EvmNftTransfer[]){=
console.log("Loading"+burnTransfers.length+"burntransfersintothedatabase");=
for(constelementofburnTransfers){=
try{=
constburn=
data:{=
minted:0,=
chain:element.chain.apiId,=
blockNumber:element.blockNumber.toString(),=
blockTimestamp:element.blockTimestamp,=
txHash:element.transactionHash,=
tokenAddress:element.tokenAddress.lowercase,=
tokenId:element.tokenId,=
fromAddress:element.fromAddress?.lowercase,=
toAddress:element.toAddress.lowercase=
},=
})=
//console.log(burn);=
}=
catch(error){=
console.log(error);=
}=
}=
prisma.$disconnect=
}=
asyncfunctionloadUserMintArray(imxclient:ImmutableX,prisma:PrismaClient){=
//Pulltokensthathaven'tbeenmintedyetfromtheDB=
constburnTransfers=
where:{minted:0},=
});=
//Gothrougheachtokenandaddanentryforeachuseroraddtoanadditionaluserentry,mintrequestsarebrokendownbyuser=
lettokensArray:{[receiverAddress:string]:any[]}=
for(constburnofburnTransfers){=
if(burn.fromAddress){=
if(tokensArray[burn.fromAddress]){=
tokensArray[burn.fromAddress].push({=
id:burn.tokenId,=
blueprint:'ipfs://'+process.env.IPFS_CID+'/'+burn.tokenId=
});=
}=
else{=
tokensArray[burn.fromAddress]=
id:burn.tokenId,=
blueprint:'ipfs://'+process.env.IPFS_CID+'/'+burn.tokenId=
}];=
}=
}=
}=
letmintArray=
letindex=
for(letkeyintokensArray){=
//CheckiftheuserisregisteredonIMX=
constisRegistered=
console.log("Checkingifrecipientaddress"+key+"isregisteredonIMX");=
if(isRegistered){=
mintArray[index]=
users:[{=
etherKey:key.toLowerCase(),=
tokens:tokensArray[key]=
}],=
contractAddress:process.env.DESTINATION_COLLECTION_ADDRESS=
}=
index++;=
}=
else{=
console.log("Recipientaddress"+key+"isnotregisteredonIMX,skipping...");=
}=
}=
returnmintArray;=
}=
asyncfunctionbatchMintArray(mintArray:any[]){=
//Mintsperbatch=
constbatchsize=
//Delaysbetweenmintrequests,recommendationis>200,at200ms,wehave5RPS=
constrequestdelays=
letbatchifiedMintArray=
for(constelementofmintArray){=
if(element.users[0].tokens.length>batchsize){=
console.log('Batching'+element.users[0].tokens.length+'tokensfor'+element.users[0].etherKey);=
//calculatetheamountofbatches=
constbatchcount=
console.log('Batchcount:'+batchcount);=
//calculatetheremainderafterthebatcheshavebeencreated=
constremainder=
console.log('Remainder:'+remainder);=
//loopforthebatches=
leti:number=
lettokenindex:number=
while(i<batchcount){=
lettokens=
letj:number=
while(j<batchsize){=
//Createthetokenarrayaccordingtothebatchsize=
tokens[j]=
id:element.users[0].tokens[j+tokenindex].id,=
blueprint:'ipfs://'+process.env.IPFS_CID+'/'+element.users[0].tokens[j+tokenindex].id,=
};=
j++=
}=
tokenindex=
batchifiedMintArray.push({=
users:[{=
etherKey:element.users[0].etherKey,=
tokens:tokens=
}],=
contractAddress:element.contractAddress=
})=
i++;=
}=
if(remainder!=
//console.log('tokenidafterbatchescomplete:'+tokenid);=
lettokens=
//Createthelastremaindertokenswhichdidn'tgetincludedinabatch=
letk:number=
while(k<remainder){=
tokens[k]=
id:element.users[0].tokens[tokenindex+k].id,=
blueprint:'ipfs://'+process.env.IPFS_CID+'/'+(tokenindex+k).toString(),=
};=
k++;=
}=
batchifiedMintArray.push({=
users:[{=
etherKey:element.users[0].etherKey,=
tokens:tokens=
}],=
contractAddress:element.contractAddress=
})=
}=
}=
else{=
batchifiedMintArray.push(element);=
}=
console.log(element.users[0].tokens.length);=
//console.log(element[0][1]);=
//console.log(element[0][1].length);=
}=
console.log("lengthoforiginal:"+mintArray.length);=
console.log("lengthofbatchifiedversion:"+batchifiedMintArray.length);=
//Writeeverythingtofile=
fs.writeFile('src/testing/mintArray.json',JSON.stringify(mintArray,null,'\t'),(err)=
if(err){=
console.error(err);=
}else{=
console.log("Mintarraywrittentodata/mintArray.json");=
}=
});=
//Writeeverythingtofile=
fs.writeFile('src/testing/batchifiedMintArray.json',JSON.stringify(batchifiedMintArray,null,'\t'),(err)=
if(err){=
console.error(err);=
}else{=
console.log("Batchifiedmintarraywrittentodata/batchifiedMintArray.json");=
}=
});=
returnmintArray;=
}=
asyncfunctionmintBatchArray(imxclient:ImmutableX,mintArray:any[]){=
for(constelementofmintArray){=
constsigner=
console.log("Minting"+element.users[0].tokens.length+"tokensfor"+element.users[0].etherKey);=
constresult=
console.log(result);=
}=
}=
asyncfunctionfindMax(){=
constprisma=
constresults=
orderBy:[=
{=
blockNumber:'desc',=
}=
]=
})=
//createmoralisclient=
awaitMoralis.start({=
apiKey:process.env.MORALIS_API_KEY,=
});=
consttodayDate=
consttest=
console.log(todayDate);=
constresponse=
date:test,=
chain:EvmChain.BSC,=
});=
console.log(response);=
console.log("Max:"+results[0].blockNumber);=
console.log("Min:"+results[results.length-1].blockNumber);=
}=
asyncfunctiongetCurrentBlock(){=
//CreatetheMoralisclient=
awaitMoralis.start({=
apiKey:process.env.MORALIS_API_KEY,=
});=
consttodayDate=
constcurrentblockresponse=
date:todayDate.toString(),=
chain:EvmChain.BSC,=
});=
constcurrentblock=
returncurrentblock;=
}=
//Checkiftheuserisregisteredonchain=
asyncfunctionisIMXRegistered(imxclient:ImmutableX,ethaddress:string):Promise<boolean>{=
try{=
constisRegistered=
returntrue;=
}=
catch(err){=
console.log(err);=
returnfalse;=
}=
}=
asyncfunctionmain(){=
//loadsthedatabasewithburns=
//constprisma=
//loadBurnTransfers(awaitgetBurnTransfersByBlockRange(undefined,21739231,22739231),prisma);=
//loadBurnTransfers(awaitgetBurnTransfersByBlockRange(undefined,23685458,24685458));=
//loadsthemintarraywhichisgoingtobepassedtothemintingfunction=
//constprisma=
//constconfig=
//constimxclient=
//batchMintArray(awaitloadUserMintArray(imxclient,prisma));=
//Checkifuserisregistered=
//console.log(awaitisIMXRegistered("0xfaDcF1dEe4D008E02e9E97513081C320Ac2748B3"));=
//findthemaxblocknumber=
//findMax();=
//backfillsacertainrange=
//backFillBurnTransfers(1200000,22739231,1000000);=
//backfillsandmonitors=
constprisma=
//awaitbackFillBurnTransfers(prisma,23862889,24862889,25000);=
monitorBurnTransfers(prisma,25078995,100);=
//getscurrentblock=
//console.log(awaitgetCurrentBlock());=
}=
main();=